<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Exchange Daily Position</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #f3f6fa; font-family: "Inter", sans-serif; }
header { text-align: center; margin: 2rem 0; }
.card { border: none; border-radius: 1rem; box-shadow: 0 3px 10px rgba(0,0,0,0.1); margin-bottom: 2rem; }
.table th { background-color: #0d6efd; color: white; text-align: center; }
.table td input { border: none; width: 100%; background: transparent; outline: none; text-align: center; }
.action-btn { cursor: pointer; color: #dc3545; font-size: 1.2rem; }
.add-row-btn { margin-top: 0.5rem; }
.btn-lg { border-radius: 0.6rem; }
footer { text-align: center; margin-top: 2rem; color: #777; font-size: 0.9rem; }
</style>
</head>
<body>
<div class="container my-4">
  <header>
    <h1>Edit Exchange Daily Position</h1>
    <p id="currentDate" class="text-secondary"></p>
  </header>

  <div class="d-flex justify-content-center gap-3 mb-4 flex-wrap">
    <button id="saveGitHub" class="btn btn-primary btn-lg shadow">üíæ Save to GitHub</button>
    <button id="downloadExcel" class="btn btn-success btn-lg shadow">üìä Download Excel</button>
  </div>

  <div class="card p-3">
    <h5 class="text-primary mb-3">Officers Movements</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle text-center" id="officersTable">
        <thead><tr><th>Designation</th><th>Name</th><th>Movement</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <button id="addOfficer" class="btn btn-outline-primary btn-sm add-row-btn">+ Add Row</button>
  </div>

  <div class="card p-3">
    <h5 class="text-danger mb-3">Pending Failures / To Do Works</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle text-center" id="failuresTable">
        <thead><tr><th>Section</th><th>Date from Pending</th><th>Description</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <button id="addFailure" class="btn btn-outline-danger btn-sm add-row-btn">+ Add Row</button>
  </div>

  <footer>
    <p>Connected to GitHub repo: <a href="https://github.com/bzaexchange/exchange-position-page" target="_blank">@bzaexchange/exchange-position-page</a></p>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
const username = "bzaexchange";
const repo = "exchange-position-page";
const filePath = "data.json";
const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${filePath}`;

document.getElementById("currentDate").textContent = new Date().toLocaleDateString('en-IN', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

async function loadData() {
  const res = await fetch(apiUrl);
  const json = await res.json();
  const data = JSON.parse(atob(json.content));
  fillTable("officersTable", data.officers);
  fillTable("failuresTable", data.failures);
}

function fillTable(id, rows) {
  const tbody = document.querySelector(`#${id} tbody`);
  tbody.innerHTML = "";
  rows.forEach(r => addRow(id, r));
}

function addRow(id, row = {col1:"", col2:"", col3:""}) {
  const tbody = document.querySelector(`#${id} tbody`);
  const tr = document.createElement("tr");
  Object.values(row).forEach(v => {
    const td = document.createElement("td");
    const inp = document.createElement("input");
    inp.value = v;
    td.appendChild(inp);
    tr.appendChild(td);
  });
  const tdAct = document.createElement("td");
  tdAct.innerHTML = '<span class="action-btn" title="Delete Row">üóëÔ∏è</span>';
  tdAct.onclick = () => tr.remove();
  tr.appendChild(tdAct);
  tbody.appendChild(tr);
}

document.getElementById("addOfficer").onclick = () => addRow("officersTable");
document.getElementById("addFailure").onclick = () => addRow("failuresTable");

document.getElementById("downloadExcel").onclick = () => {
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(document.getElementById("officersTable")), "Officers Movements");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(document.getElementById("failuresTable")), "Pending Failures");
  XLSX.writeFile(wb, `Exchange_Daily_Position_${new Date().toISOString().split('T')[0]}.xlsx`);
};

async function getCurrentSha() {
  const res = await fetch(apiUrl);
  const json = await res.json();
  return json.sha;
}

document.getElementById("saveGitHub").onclick = async () => {
  const token = prompt("Enter your GitHub Personal Access Token (repo access):");
  if (!token) return alert("‚ùå Token required.");

  const officers = extractTable("officersTable");
  const failures = extractTable("failuresTable");
  const data = { officers, failures };
  const sha = await getCurrentSha();

  const body = {
    message: "Update Exchange Daily Position via edit.html",
    content: btoa(JSON.stringify(data, null, 2)),
    sha
  };

  const res = await fetch(apiUrl, {
    method: "PUT",
    headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  if (res.ok) alert("‚úÖ Data updated successfully!");
  else alert("‚ùå Failed to update. Check your token and repo permissions.");
};

function extractTable(id) {
  const rows = [];
  document.querySelectorAll(`#${id} tbody tr`).forEach(tr => {
    const inputs = tr.querySelectorAll("input");
    rows.push({
      col1: inputs[0]?.value || "",
      col2: inputs[1]?.value || "",
      col3: inputs[2]?.value || ""
    });
  });
  return rows;
}

loadData();
</script>
</body>
</html>
